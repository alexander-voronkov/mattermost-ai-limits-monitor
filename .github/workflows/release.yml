name: Release Build

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    name: Build & Release
    runs-on: [self-hosted, Linux]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Build server (all platforms)
        working-directory: server
        run: |
          mkdir -p dist
          for platform in linux/amd64 linux/arm64 darwin/amd64 darwin/arm64 windows/amd64; do
            os="${platform%/*}"
            arch="${platform#*/}"
            ext=""
            if [ "$os" = "windows" ]; then ext=".exe"; fi
            echo "Building $os/$arch..."
            CGO_ENABLED=0 GOOS=$os GOARCH=$arch go build -trimpath -o "dist/plugin-${os}-${arch}${ext}" .
          done

      - name: Install webapp deps
        working-directory: webapp
        run: npm install --legacy-peer-deps

      - name: Build webapp
        working-directory: webapp
        run: npm run build

      - name: Create bundle
        run: make bundle

      - name: Get version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "AI Limits Monitor ${{ steps.version.outputs.version }}"
          body: |
            ## AI Limits Monitor ${{ steps.version.outputs.version }}

            ### Installation
            1. Download the `.tar.gz` bundle below
            2. Go to **System Console → Plugins → Plugin Management**
            3. Upload the bundle
            4. Enable the plugin
            5. Configure API keys in **System Console → Plugins → AI Limits Monitor**

            ### Supported Platforms
            - Linux amd64 / arm64
            - macOS amd64 / arm64
            - Windows amd64

            ### Mattermost Compatibility
            - Mattermost 10.x - 11.x
          files: |
            dist/com.fambear.ai-limits-monitor-*.tar.gz
          draft: false
          prerelease: false
